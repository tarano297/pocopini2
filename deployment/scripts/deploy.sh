#!/bin/bash
# ุงุณฺฉุฑูพุช ุงุณุชูุฑุงุฑ ูพูฺฉููพู

set -e

echo "๐ ุดุฑูุน ูุฑุขูุฏ ุงุณุชูุฑุงุฑ..."

# ุฑูฺฏโูุง ุจุฑุง ุฎุฑูุฌ
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# ุจุฑุฑุณ ูุชุบุฑูุง ูุญุท
if [ ! -f "backend/.env" ]; then
    echo "โ ูุงู .env ุงูุช ูุดุฏ. ูุทูุงู ุงุจุชุฏุง ุขู ุฑุง ุงุฌุงุฏ ฺฉูุฏ."
    exit 1
fi

# Pull ฺฉุฑุฏู ุขุฎุฑู ุชุบุฑุงุช
echo -e "${YELLOW}๐ฅ ุฏุฑุงูุช ุขุฎุฑู ุชุบุฑุงุช...${NC}"
git pull origin main

# ูุตุจ ูุงุจุณุชฺฏโูุง ุจฺฉโุงูุฏ
echo -e "${YELLOW}๐ฆ ูุตุจ ูุงุจุณุชฺฏโูุง ุจฺฉโุงูุฏ...${NC}"
cd backend
pip install -r requirements.txt

# ุงุฌุฑุง ูุงฺฏุฑุดูโูุง
echo -e "${YELLOW}๐๏ธ  ุงุฌุฑุง ูุงฺฏุฑุดูโูุง...${NC}"
python manage.py migrate

# ุฌูุนโุขูุฑ ูุงูโูุง ุงุณุชุงุชฺฉ
echo -e "${YELLOW}๐ ุฌูุนโุขูุฑ ูุงูโูุง ุงุณุชุงุชฺฉ...${NC}"
python manage.py collectstatic --noinput

cd ..

# Build ฺฉุฑุฏู ูุฑุงูุชโุงูุฏ
echo -e "${YELLOW}๐๏ธ  Build ฺฉุฑุฏู ูุฑุงูุชโุงูุฏ...${NC}"
cd frontend
npm install
npm run build

cd ..

# ุฑุงูโุงูุฏุงุฒ ูุฌุฏุฏ ุณุฑูุณโูุง
echo -e "${YELLOW}๐ ุฑุงูโุงูุฏุงุฒ ูุฌุฏุฏ ุณุฑูุณโูุง...${NC}"
sudo systemctl restart pokopini
sudo systemctl restart nginx

echo -e "${GREEN}โ ุงุณุชูุฑุงุฑ ุจุง ููููุช ุงูุฌุงู ุดุฏ!${NC}"
echo -e "${GREEN}๐ ุณุงุช ุดูุง ุฏุฑ ุฏุณุชุฑุณ ุงุณุช.${NC}"
